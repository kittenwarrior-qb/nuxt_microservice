name: Simple Deployment

on:
  push:
    branches: [production]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          timeout: 8m
          script: |
            cd /root/repositories/thegioididong
            
            # Git configuration
            git config --global --unset-all http.https://github.com/.extraheader || true
            git config --system --unset-all http.https://github.com/.extraheader || true
            git config --local --unset-all http.https://github.com/.extraheader || true
            git config --global --add safe.directory /root/repositories/thegioididong || true
            
            set -e
            git fetch --all --prune
            git checkout production || git checkout -b production
            git reset --hard origin/production
            git clean -fd
            
            # Simple deployment
            echo "Starting deployment..."
            
            # Stop containers
            docker-compose down --timeout 30
            
            # Clean up
            docker system prune -f
            docker image prune -f
            
            # Build and start everything
            docker-compose build --no-cache
            docker-compose up -d
            
            echo "Deployment complete!"
            docker-compose ps
